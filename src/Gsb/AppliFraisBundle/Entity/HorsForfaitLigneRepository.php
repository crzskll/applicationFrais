<?php

namespace Gsb\AppliFraisBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * HorsForfaitLigneRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HorsForfaitLigneRepository extends EntityRepository
{
	public function ligneByDate($visiteur, $dateDeb, $dateFin)
  	{
	  	$qb = $this->createQueryBuilder('l');

	    $qb
	      ->leftJoin('l.fiche', 'f')
	      ->addSelect('f')
	      ->leftJoin('f.etat', 'et')
	      ->addSelect('et')
	      ->leftJoin('f.employe', 'e')
	      ->where('e = :visiteur')
	      	->setParameter('visiteur', $visiteur)
	      ->andWhere('l.date BETWEEN :start AND :end')
		    ->setParameter('start', $dateDeb)
		    ->setParameter('end',   $dateFin)
		  ->andWhere('et.libelle != :etat')
		    ->setParameter('etat', 'En cours')
	    ;

	    return $qb
	    	->getQuery()
	    	->getResult()
	  	;
	}

  	public function ligneByDateStatut($visiteur, $dateDeb, $dateFin, $statut)
  	{
  		$qb = $this->createQueryBuilder('l');

	    $qb
	   	  ->leftJoin('l.fiche', 'f')
	      ->addSelect('f')
	      ->leftJoin('f.etat', 'et')
	      ->addSelect('et')
	      ->leftJoin('f.employe', 'e')
	      ->where('e = :visiteur')
	      	->setParameter('visiteur', $visiteur)
	      ->andWhere('l.date BETWEEN :start AND :end')
		    ->setParameter('start', $dateDeb)
		    ->setParameter('end',   $dateFin)
	      ->andWhere('l.statut = :statut')
		  	->setParameter('statut', $statut)
		  ->andWhere('et.libelle != :etat')
		    ->setParameter('etat', 'En cours')
		  
	    ;

	    return $qb
	    	->getQuery()
	    	->getResult()
	  	;
 	}
}
